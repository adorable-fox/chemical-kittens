---
import '../styles/global.css';
interface Props {
	title: string;
}

import { getCollection } from 'astro:content';

const { title } = Astro.props;
const allRecipes = await getCollection('recipes');
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="My Recipe Collection" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
	</head>
	<body>
		<div class="container">
			<header>
                <div class="header-left">
				    <a href="/"><h1>üç≥ Cookbook</h1></a>
				    <p class="subtitle">Most recipes nicked from somewhere and adjusted to our liking</p>
                </div>
                <div class="header-right" style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                    <div class="header-top-row" style="display: flex; gap: 1rem; align-items: center; width: 100%; max-width: 800px;">
                        <button id="theme-toggle" aria-label="Toggle dark mode">üåô</button>
                        <div class="search-container" style="flex: 1;">
                            <input type="text" id="search-input" placeholder="Search recipes..." autocomplete="off">
                            <div id="search-results" class="search-results"></div>
                        </div>
                    </div>
                    <div class="filters" style="width: 100%; max-width: 800px;">
                        <select class="filter-select" id="filter-type">
                            <option value="">Type</option>
                            {Array.from(new Set(allRecipes.map(r => r.data.recipeType).filter(Boolean))).sort().map(t => (
                                <option value={t}>{t}</option>
                            ))}
                        </select>
                        <select class="filter-select" id="filter-ingredient">
                            <option value="">Ingredient</option>
                            {Array.from(new Set(allRecipes.map(r => r.data.mainIngredient).filter(Boolean))).sort().map(t => (
                                <option value={t}>{t}</option>
                            ))}
                        </select>
                        <select class="filter-select" id="filter-country">
                            <option value="">Country</option>
                            {Array.from(new Set(allRecipes.map(r => r.data.country).filter(Boolean))).sort().map(t => (
                                <option value={t}>{t}</option>
                            ))}
                        </select>
                    </div>
                </div>
			</header>

            <script>
                const searchInput = document.getElementById('search-input');
                const searchResults = document.getElementById('search-results');

                // Theme Toggle Logic
                const themeToggle = document.getElementById('theme-toggle');
                
                // Check for saved user preference, if any, on load
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    themeToggle.textContent = '‚òÄÔ∏è';
                }

                themeToggle.addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                    themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                });
                
                let recipes = [];

                // Fetch recipes on first focus (lazy load)
                searchInput.addEventListener('focus', async () => {
                    if (recipes.length === 0) {
                        const res = await fetch('/search.json');
                        recipes = await res.json();
                    }
                });

                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    if (term.length < 2) {
                        searchResults.style.display = 'none';
                        return;
                    }

                    const filtered = recipes.filter(r => 
                        r.title.toLowerCase().includes(term) || 
                        r.tags.some(tag => tag.toLowerCase().includes(term))
                    );

                    if (filtered.length > 0) {
                        searchResults.innerHTML = filtered.map(r => `
                            <a href="/recipes/${r.slug}" class="search-result-item">
                                <div class="result-title">${r.title}</div>
                                <div class="result-meta">${r.tags.map(t => '#' + t).join(' ')}</div>
                            </a>
                        `).join('');
                        searchResults.style.display = 'block';
                    } else {
                        searchResults.innerHTML = '<div class="no-results">No matches found</div>';
                        searchResults.style.display = 'block';
                    }
                });

                const filterSelects = document.querySelectorAll('.filter-select');
                filterSelects.forEach(select => {
                    select.addEventListener('change', (e) => {
                        const value = e.target.value;
                        if (value) {
                            window.location.href = `/tags/${value.toLowerCase().replace(/ /g, '-')}`;
                        }
                    });
                });
            </script>
			<main>
				<slot />
			</main>
		</div>
	</body>
</html>
